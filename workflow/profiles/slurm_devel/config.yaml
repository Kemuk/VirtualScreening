# Snakemake SLURM Profile - Development/Testing
# ==============================================
# Usage: snakemake --profile workflow/profiles/slurm_devel --config mode=devel <target>
#
# This profile uses shorter time limits and the devel/short partition
# for quick turnaround during testing.

# Use cluster submission for array job support
cluster: >-
  sbatch
  --parsable
  --job-name=vs_{rule}
  --partition={resources.slurm_partition}
  --time={resources.runtime}
  --mem={resources.mem_mb}M
  --cpus-per-task={resources.cpus_per_task}
  --mail-user=reub0582@ox.ac.uk
  --mail-type=END,FAIL
  {resources.slurm_extra}

cluster-status: "sacct -j {jobid} --format=State --noheader | head -1 | awk '{print $1}'"
cluster-cancel: "scancel"

# Job settings
jobs: 10                           # Limited concurrent jobs for testing
latency-wait: 5                    # Short wait time for devel
retries: 1                         # Fewer retries during testing
printshellcmds: true
keep-going: false                  # Stop on first failure during testing

# Default resources - use devel partition with short times
default-resources:
  slurm_partition: "devel"
  mem_mb: 4000
  runtime: 2                       # 2 minutes default
  cpus_per_task: 2
  slurm_extra: ""

# Per-rule resource overrides - all 2 minutes for testing
set-resources:
  # =========================================
  # Manifest & Preparation
  # =========================================
  create_manifest:
    slurm_partition: "devel"
    runtime: 2
    mem_mb: 8000
    cpus_per_task: 4

  prepare_receptor:
    slurm_partition: "devel"
    runtime: 2
    mem_mb: 2000
    cpus_per_task: 1

  prepare_all_ligands:
    slurm_partition: "devel"
    runtime: 2
    mem_mb: 8000
    cpus_per_task: 4

  # =========================================
  # Docking
  # =========================================
  dock_ligand_gpu:
    slurm_partition: "devel"
    slurm_extra: "--gres=gpu:1"
    runtime: 2
    mem_mb: 8000
    cpus_per_task: 2

  dock_ligand_cpu:
    slurm_partition: "devel"
    runtime: 2
    mem_mb: 16000
    cpus_per_task: 8

  # =========================================
  # SDF Conversion
  # =========================================
  convert_to_sdf:
    slurm_partition: "devel"
    runtime: 2
    mem_mb: 4000
    cpus_per_task: 2

  convert_all_sdf:
    slurm_partition: "devel"
    runtime: 2
    mem_mb: 8000
    cpus_per_task: 4

  # =========================================
  # AEV-PLIG Rescoring
  # =========================================
  prepare_aev_plig_input:
    slurm_partition: "devel"
    runtime: 2
    mem_mb: 8000
    cpus_per_task: 4

  shard_aev_plig_csv:
    slurm_partition: "devel"
    runtime: 2
    mem_mb: 4000
    cpus_per_task: 2

  run_aev_plig_shard:
    slurm_partition: "devel"
    slurm_extra: "--gres=gpu:1"
    runtime: 2
    mem_mb: 8000
    cpus_per_task: 2

  merge_aev_plig_predictions:
    slurm_partition: "devel"
    runtime: 2
    mem_mb: 4000
    cpus_per_task: 2

  update_manifest_aev_plig:
    slurm_partition: "devel"
    runtime: 2
    mem_mb: 8000
    cpus_per_task: 2

  # =========================================
  # Results & Plotting
  # =========================================
  compute_results:
    slurm_partition: "devel"
    runtime: 2
    mem_mb: 8000
    cpus_per_task: 4

  make_plots:
    slurm_partition: "devel"
    runtime: 2
    mem_mb: 8000
    cpus_per_task: 4

# Group similar jobs together for array-like submission
group-components:
  run_aev_plig_shard: 5
  dock_ligand_gpu: 5
  dock_ligand_cpu: 5
  convert_to_sdf: 10
