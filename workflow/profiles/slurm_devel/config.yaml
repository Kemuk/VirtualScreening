# Snakemake SLURM Profile - Development/Testing (Snakemake 8.x)
# ==============================================================
# Usage: snakemake --profile workflow/profiles/slurm_devel --config mode=devel <target>
#
# This profile uses shorter time limits and the devel partition
# for quick turnaround during testing.

# Executor settings (Snakemake 8.x)
executor: slurm
jobs: 10                           # Max concurrent jobs
latency-wait: 5                    # Short wait time for devel
retries: 1                         # Fewer retries during testing
printshellcmds: true
keep-going: false                  # Stop on first failure during testing
slurm-logdir: "data/logs/slurm"

# Job naming - use rule name for descriptive squeue output
jobname: "vs-{rule}"

# Default resources - use devel partition with short times
default-resources:
  slurm_partition: "devel"
  mem_mb: 4000
  cpus_per_task: 2
  runtime: 10

# Per-rule resource overrides - all 2 minutes for testing
set-resources:
  # =========================================
  # Manifest & Preparation
  # =========================================
  create_manifest:
    slurm_partition: "devel"
    slurm_extra: "'--mail-user=reub0582@ox.ac.uk --mail-type=BEGIN,FAIL'"
    mem_mb: 32000
    cpus_per_task: 16

  prepare_receptor:
    slurm_partition: "devel"
    mem_mb: 2000
    cpus_per_task: 1

  prepare_all_ligands:
    slurm_partition: "devel"
    mem_mb: 8000
    cpus_per_task: 4

  shard_preparation:
    slurm_partition: "devel"
    slurm_extra: "'--mail-user=reub0582@ox.ac.uk --mail-type=BEGIN,FAIL'"
    mem_mb: 8000
    cpus_per_task: 2

  prepare_ligand_chunk:
    slurm_partition: "devel"
    mem_mb: 8000
    cpus_per_task: 4

  merge_preparation_results:
    slurm_partition: "devel"
    mem_mb: 4000
    cpus_per_task: 2

  # =========================================
  # Docking
  # =========================================
  dock_ligand_gpu:
    slurm_partition: "devel"
    slurm_extra: "'--clusters=htc'"
    mem_mb: 8000
    cpus_per_task: 2

  dock_ligand_cpu:
    slurm_partition: "devel"
    mem_mb: 16000
    cpus_per_task: 8

  shard_docking:
    slurm_partition: "devel"
    slurm_extra: "'--mail-user=reub0582@ox.ac.uk --mail-type=BEGIN,FAIL'"
    mem_mb: 4000
    cpus_per_task: 2

  dock_chunk:
    slurm_partition: "devel"
    slurm_extra: "'--clusters=htc'"
    mem_mb: 8000
    cpus_per_task: 2

  merge_docking_results:
    slurm_partition: "devel"
    mem_mb: 4000
    cpus_per_task: 2

  # =========================================
  # SDF Conversion
  # =========================================
  convert_to_sdf:
    slurm_partition: "devel"
    mem_mb: 4000
    cpus_per_task: 2

  convert_all_sdf:
    slurm_partition: "devel"
    mem_mb: 8000
    cpus_per_task: 4

  shard_conversion:
    slurm_partition: "devel"
    slurm_extra: "'--mail-user=reub0582@ox.ac.uk --mail-type=BEGIN,FAIL'"
    mem_mb: 4000
    cpus_per_task: 2

  convert_chunk_to_sdf:
    slurm_partition: "devel"
    mem_mb: 8000
    cpus_per_task: 4

  merge_conversion_results:
    slurm_partition: "devel"
    mem_mb: 4000
    cpus_per_task: 2

  # =========================================
  # AEV-PLIG Rescoring
  # =========================================
  prepare_aev_plig_input:
    slurm_partition: "devel"
    mem_mb: 8000
    cpus_per_task: 4

  shard_aev_plig_csv:
    slurm_partition: "devel"
    slurm_extra: "'--mail-user=reub0582@ox.ac.uk --mail-type=BEGIN,FAIL'"
    mem_mb: 4000
    cpus_per_task: 2

  aev_plig_array:
    slurm_partition: "devel"
    slurm_extra: "'--mail-user=reub0582@ox.ac.uk --mail-type=BEGIN,FAIL'"
    mem_mb: 2000
    cpus_per_task: 1

  run_aev_plig_shard:
    slurm_partition: "devel"
    slurm_extra: "'--clusters=htc'"
    mem_mb: 8000
    cpus_per_task: 2

  merge_aev_plig_predictions:
    slurm_partition: "devel"
    mem_mb: 4000
    cpus_per_task: 2

  update_manifest_aev_plig:
    slurm_partition: "devel"
    mem_mb: 8000
    cpus_per_task: 2

  # =========================================
  # Results & Plotting
  # =========================================
  compute_results:
    slurm_partition: "devel"
    mem_mb: 8000
    cpus_per_task: 4

  make_plots:
    slurm_partition: "devel"
    mem_mb: 8000
    cpus_per_task: 4
