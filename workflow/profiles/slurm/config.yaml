# Snakemake SLURM Profile - Production (Snakemake 8.x)
# =====================================================
# Usage: snakemake --profile workflow/profiles/slurm <target>

# Executor settings (Snakemake 8.x)
executor: slurm
jobs: 100
latency-wait: 60                   # Wait for files to appear (NFS lag)
retries: 2                         # Retry failed jobs
printshellcmds: true
keep-going: true                   # Continue with independent jobs on failure
slurm-logdir: "data/logs/slurm"

# Job naming - use rule name for descriptive squeue output
jobname: "vs-{rule}-{jobid}"

# Default resources (applied to all rules unless overridden)
default-resources:
  mem_mb: 16000
  runtime: 60                      # minutes
  cpus_per_task: 16

# Per-rule resource overrides
set-resources:
  # =========================================
  # Manifest & Preparation
  # =========================================
  create_manifest:
    slurm_extra: "'--requeue'"
    runtime: 60
    mem_mb: 32000
    cpus_per_task: 16

  shard_vina_backfill:
    runtime: 30
    mem_mb: 16000
    cpus_per_task: 8

  vina_backfill_array:
    runtime: 30
    mem_mb: 2000
    cpus_per_task: 1

  merge_vina_backfill:
    runtime: 30
    mem_mb: 16000
    cpus_per_task: 8

  prepare_receptor:
    runtime: 10
    mem_mb: 4000
    cpus_per_task: 4

  prepare_all_ligands:
    slurm_extra: "'--requeue'"
    runtime: 60
    mem_mb: 16000
    cpus_per_task: 16

  shard_preparation:
    runtime: 30
    mem_mb: 16000
    cpus_per_task: 8

  prepare_ligand_chunk:
    runtime: 120
    mem_mb: 16000
    cpus_per_task: 8

  merge_preparation_results:
    runtime: 30
    mem_mb: 16000
    cpus_per_task: 8

  # =========================================
  # Docking
  # =========================================
  dock_ligand_gpu:
    cluster: "htc"
    slurm_extra: "'--requeue'"
    runtime: 90
    mem_mb: 2000
    cpus_per_task: 2

  dock_ligand_cpu:
    slurm_extra: "'--requeue'"
    runtime: 90
    mem_mb: 16000
    cpus_per_task: 16

  shard_docking:
    runtime: 30
    mem_mb: 16000
    cpus_per_task: 16

  dock_chunk:
    cluster: "htc"
    runtime: 90
    mem_mb: 2000
    cpus_per_task: 2

  dock_array:
    runtime: 90
    mem_mb: 4000
    cpus_per_task: 2

  merge_docking_results:
    runtime: 30
    mem_mb: 16000
    cpus_per_task: 8


  # =========================================
  # SDF Conversion
  # =========================================
  convert_to_sdf:
    runtime: 30
    mem_mb: 16000
    cpus_per_task: 8

  convert_all_sdf:
    runtime: 60
    mem_mb: 16000
    cpus_per_task: 8


  shard_conversion:
    runtime: 30
    mem_mb: 16000
    cpus_per_task: 4

  convert_chunk_to_sdf:
    runtime: 60
    mem_mb: 16000
    cpus_per_task: 8

  merge_conversion_results:
    runtime: 30
    mem_mb: 16000
    cpus_per_task: 4

  # =========================================
  # AEV-PLIG Rescoring
  # =========================================
  prepare_aev_plig_input:
    runtime: 30
    mem_mb: 16000
    cpus_per_task: 16

  shard_aev_plig_csv:
    runtime: 10
    mem_mb: 16000
    cpus_per_task: 8

  aev_plig_array:
    slurm_extra: "'--requeue'"
    runtime: 30
    mem_mb: 8000
    cpus_per_task: 8

  run_aev_plig_shard:
    cluster: "htc"
    runtime: 120                   # 2 hours per shard
    mem_mb: 16000
    cpus_per_task: 8

  merge_aev_plig_predictions:
    runtime: 60
    mem_mb: 16000
    cpus_per_task: 8

  update_manifest_aev_plig:
    runtime: 30
    mem_mb: 16000
    cpus_per_task: 8

  # =========================================
  # Results & Plotting
  # =========================================
  compute_results:
    runtime: 60
    mem_mb: 16000
    cpus_per_task: 16

  make_plots:
    runtime: 30
    mem_mb: 16000
    cpus_per_task: 8
