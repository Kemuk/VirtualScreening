# Snakemake SLURM Profile - Production (Snakemake 8.x)
# =====================================================
# Usage: snakemake --profile workflow/profiles/slurm <target>

# Executor settings (Snakemake 8.x)
executor: slurm
jobs: 100                          # Max concurrent jobs
latency-wait: 60                   # Wait for files to appear (NFS lag)
retries: 2                         # Retry failed jobs
printshellcmds: true
keep-going: true                   # Continue with independent jobs on failure
slurm-logdir: "data/logs/slurm"

# Default resources (applied to all rules unless overridden)
default-resources:
  mem_mb: 8000
  runtime: 30                      # minutes
  cpus_per_task: 4

# Per-rule resource overrides
set-resources:
  # =========================================
  # Manifest & Preparation
  # =========================================
  create_manifest:
    slurm_extra: "'--mail-user=reub0582@ox.ac.uk --mail-type=BEGIN,FAIL'"
    runtime: 20
    mem_mb: 32000
    cpus_per_task: 16

  prepare_receptor:
    runtime: 10
    mem_mb: 4000
    cpus_per_task: 2

  prepare_all_ligands:
    runtime: 120
    mem_mb: 16000
    cpus_per_task: 16

  shard_preparation:
    slurm_extra: "'--mail-user=reub0582@ox.ac.uk --mail-type=BEGIN,FAIL'"
    runtime: 20
    mem_mb: 16000
    cpus_per_task: 4

  prepare_ligand_chunk:
    runtime: 120
    mem_mb: 16000
    cpus_per_task: 16

  merge_preparation_results:
    runtime: 20
    mem_mb: 16000
    cpus_per_task: 4

  # =========================================
  # Docking
  # =========================================
  dock_ligand_gpu:
    slurm_extra: "'--clusters=htc'"
    runtime: 720                   # 12 hours
    mem_mb: 20000
    cpus_per_task: 2

  dock_ligand_cpu:
    runtime: 720                   # 12 hours
    mem_mb: 64000
    cpus_per_task: 32

  shard_docking:
    slurm_extra: "'--mail-user=reub0582@ox.ac.uk --mail-type=BEGIN,FAIL'"
    runtime: 20
    mem_mb: 16000
    cpus_per_task: 4

  dock_chunk:
    slurm_extra: "'--clusters=htc'"
    runtime: 720
    mem_mb: 20000
    cpus_per_task: 2

  merge_docking_results:
    runtime: 20
    mem_mb: 16000
    cpus_per_task: 4

  # =========================================
  # SDF Conversion
  # =========================================
  convert_to_sdf:
    runtime: 30
    mem_mb: 8000
    cpus_per_task: 4

  convert_all_sdf:
    runtime: 60
    mem_mb: 16000
    cpus_per_task: 8

  shard_conversion:
    slurm_extra: "'--mail-user=reub0582@ox.ac.uk --mail-type=BEGIN,FAIL'"
    runtime: 20
    mem_mb: 16000
    cpus_per_task: 4

  convert_chunk_to_sdf:
    runtime: 60
    mem_mb: 16000
    cpus_per_task: 8

  merge_conversion_results:
    runtime: 20
    mem_mb: 16000
    cpus_per_task: 4

  # =========================================
  # AEV-PLIG Rescoring
  # =========================================
  prepare_aev_plig_input:
    runtime: 20
    mem_mb: 32000
    cpus_per_task: 16

  shard_aev_plig_csv:
    slurm_extra: "'--mail-user=reub0582@ox.ac.uk --mail-type=BEGIN,FAIL'"
    runtime: 10
    mem_mb: 16000
    cpus_per_task: 4

  run_aev_plig_shard:
    slurm_extra: "'--clusters=htc'"
    runtime: 120                   # 2 hours per shard
    mem_mb: 16000
    cpus_per_task: 4

  merge_aev_plig_predictions:
    runtime: 10
    mem_mb: 16000
    cpus_per_task: 4

  update_manifest_aev_plig:
    runtime: 20
    mem_mb: 16000
    cpus_per_task: 4

  # =========================================
  # Results & Plotting
  # =========================================
  compute_results:
    runtime: 30
    mem_mb: 32000
    cpus_per_task: 16

  make_plots:
    runtime: 30
    mem_mb: 16000
    cpus_per_task: 8
